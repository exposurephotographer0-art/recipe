<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>& Dine ‚Äî Dinner Planner</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f0e0c;
    --surface: #1a1814;
    --surface2: #242118;
    --border: #2e2b24;
    --accent: #d4a843;
    --accent2: #e8c97a;
    --text: #f0ead8;
    --text-muted: #7a7364;
    --text-soft: #b0a890;
    --danger: #c45c3a;
    --success: #6a9e6f;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { background:var(--bg); color:var(--text); font-family:'DM Sans',sans-serif; min-height:100vh; font-size:15px; }

  /* HEADER */
  header {
    padding: 20px 36px;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
    position: sticky; top:0; background:var(--bg); z-index:100;
  }
  .logo { font-family:'Playfair Display',serif; font-size:1.5rem; color:var(--accent); }
  nav { display:flex; gap:4px; }
  nav button {
    background:none; border:none; color:var(--text-muted);
    font-family:'DM Sans',sans-serif; font-size:0.82rem; letter-spacing:0.08em;
    text-transform:uppercase; padding:8px 16px; cursor:pointer; border-radius:6px; transition:all 0.2s;
  }
  nav button.active, nav button:hover { background:var(--surface2); color:var(--accent); }
  .badge {
    background:var(--accent); color:var(--bg); font-size:0.62rem; font-weight:700;
    padding:2px 6px; border-radius:10px; margin-left:4px; vertical-align:middle;
  }

  /* LAYOUT */
  main { max-width:1120px; margin:0 auto; padding:36px 24px; }
  .view { display:none; }
  .view.active { display:block; }
  .page-title { font-family:'Playfair Display',serif; font-size:1.9rem; margin-bottom:6px; }
  .page-sub { color:var(--text-muted); font-size:0.88rem; margin-bottom:28px; }

  /* BUTTONS */
  .btn-primary {
    background:var(--accent); color:var(--bg); border:none;
    padding:11px 26px; border-radius:8px; font-family:'DM Sans',sans-serif;
    font-weight:500; font-size:0.88rem; cursor:pointer; transition:background 0.2s;
  }
  .btn-primary:hover { background:var(--accent2); }
  .btn-secondary {
    background:var(--surface2); color:var(--text-soft); border:1px solid var(--border);
    padding:11px 22px; border-radius:8px; font-family:'DM Sans',sans-serif;
    font-size:0.88rem; cursor:pointer; transition:all 0.2s;
  }
  .btn-secondary:hover { border-color:var(--accent); color:var(--accent); }
  .btn-sm {
    font-size:0.72rem; padding:5px 10px; border-radius:6px;
    border:1px solid var(--border); background:var(--surface2);
    color:var(--text-muted); cursor:pointer; font-family:'DM Sans',sans-serif; transition:all 0.15s;
  }
  .btn-sm:hover { border-color:var(--accent); color:var(--accent); }
  .btn-sm.danger:hover { border-color:var(--danger); color:var(--danger); }
  .icon-btn {
    background:none; border:1px solid var(--border); color:var(--text-muted);
    width:32px; height:32px; border-radius:6px; cursor:pointer;
    display:flex; align-items:center; justify-content:center; font-size:1rem; transition:all 0.15s; flex-shrink:0;
  }
  .icon-btn:hover { border-color:var(--danger); color:var(--danger); }

  /* WEEK GRID */
  .week-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:10px; margin-bottom:28px; }
  .day-card {
    background:var(--surface); border:1px solid var(--border); border-radius:12px;
    padding:14px 12px; min-height:155px; display:flex; flex-direction:column; gap:8px; transition:border-color 0.2s;
  }
  .day-card:hover { border-color:var(--accent); }
  .day-label { font-size:0.68rem; text-transform:uppercase; letter-spacing:0.12em; color:var(--text-muted); font-weight:500; }
  .day-meal { font-size:0.85rem; color:var(--text-soft); flex:1; line-height:1.4; }
  .day-meal.empty { color:var(--border); font-style:italic; font-size:0.78rem; }
  .day-actions { display:flex; gap:5px; flex-wrap:wrap; }
  .bottom-bar { display:flex; gap:12px; align-items:center; padding-top:22px; border-top:1px solid var(--border); }

  /* MODALS */
  .modal-overlay {
    position:fixed; inset:0; background:rgba(0,0,0,0.78); z-index:200;
    display:none; align-items:center; justify-content:center; padding:20px;
  }
  .modal-overlay.open { display:flex; }
  .modal {
    background:var(--surface); border:1px solid var(--border); border-radius:16px;
    padding:30px; width:100%; max-width:540px; max-height:90vh; overflow-y:auto;
  }
  .modal.wide { max-width:680px; }
  .modal h2 { font-family:'Playfair Display',serif; font-size:1.35rem; margin-bottom:18px; color:var(--accent); }
  .form-group { margin-bottom:14px; }
  label { display:block; font-size:0.78rem; text-transform:uppercase; letter-spacing:0.1em; color:var(--text-muted); margin-bottom:5px; }
  input[type="text"], textarea, select {
    width:100%; background:var(--surface2); border:1px solid var(--border);
    color:var(--text); padding:9px 13px; border-radius:8px;
    font-family:'DM Sans',sans-serif; font-size:0.93rem; outline:none; transition:border-color 0.2s;
  }
  input:focus, textarea:focus, select:focus { border-color:var(--accent); }
  textarea { resize:vertical; min-height:75px; }
  select option { background:var(--surface2); }
  .ingredient-row { display:grid; grid-template-columns:1fr 75px 85px auto; gap:7px; margin-bottom:7px; align-items:center; }
  .ingredient-row input { margin:0; }
  .add-ingredient-btn {
    background:none; border:1px dashed var(--border); color:var(--text-muted);
    padding:7px; border-radius:8px; cursor:pointer; font-family:'DM Sans',sans-serif;
    font-size:0.83rem; width:100%; transition:all 0.2s; margin-top:3px;
  }
  .add-ingredient-btn:hover { border-color:var(--accent); color:var(--accent); }
  .modal-actions { display:flex; gap:10px; margin-top:22px; justify-content:flex-end; flex-wrap:wrap; }

  /* SHOPPING */
  .shopping-header { display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:24px; gap:16px; flex-wrap:wrap; }
  .ingredient-list { display:flex; flex-direction:column; gap:7px; }
  .ingredient-item {
    background:var(--surface); border:1px solid var(--border); border-radius:10px;
    padding:12px 16px; display:flex; align-items:center; gap:12px; transition:opacity 0.2s;
  }
  .ingredient-item.checked { opacity:0.4; }
  .ingredient-item.checked .ing-name { text-decoration:line-through; }
  .ingredient-item input[type="checkbox"] { width:17px; height:17px; accent-color:var(--accent); cursor:pointer; flex-shrink:0; }
  .ing-name { flex:1; font-size:0.93rem; }
  .ing-qty { color:var(--text-muted); font-size:0.83rem; white-space:nowrap; }
  .ing-meal { font-size:0.72rem; color:var(--border); font-style:italic; }

  /* PANTRY */
  .pantry-toolbar { display:flex; gap:10px; align-items:flex-start; margin-bottom:20px; flex-wrap:wrap; justify-content:space-between; }
  .pantry-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(210px,1fr)); gap:10px; }
  .pantry-item {
    background:var(--surface); border:1px solid var(--border); border-radius:10px;
    padding:14px 16px; display:flex; align-items:center; justify-content:space-between; gap:8px;
  }
  .pantry-item-info .p-name { font-size:0.92rem; color:var(--text); }
  .pantry-item-info .p-qty { font-size:0.8rem; color:var(--text-muted); margin-top:2px; }
  .pantry-item-info .p-added { font-size:0.7rem; color:var(--border); margin-top:3px; }
  .pantry-item-actions { display:flex; gap:5px; flex-shrink:0; }
  .edit-btn, .remove-btn {
    background:none; border:1px solid var(--border); border-radius:6px;
    color:var(--text-muted); cursor:pointer; font-size:0.75rem; padding:4px 8px; transition:all 0.15s;
  }
  .edit-btn:hover { border-color:var(--accent); color:var(--accent); }
  .remove-btn:hover { border-color:var(--danger); color:var(--danger); }

  /* RECIPES */
  .recipes-toolbar { display:flex; gap:10px; align-items:flex-start; margin-bottom:16px; flex-wrap:wrap; justify-content:space-between; }
  .recipes-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:14px; }
  .recipe-card {
    background:var(--surface); border:1px solid var(--border); border-radius:12px;
    padding:20px; display:flex; flex-direction:column; gap:10px; transition:border-color 0.2s;
  }
  .recipe-card:hover { border-color:var(--accent); }
  .recipe-card-header { display:flex; align-items:flex-start; justify-content:space-between; gap:8px; }
  .recipe-name { font-family:'Playfair Display',serif; font-size:1.05rem; color:var(--text); flex:1; }
  .recipe-tag {
    font-size:0.65rem; text-transform:uppercase; letter-spacing:0.1em;
    background:var(--surface2); border:1px solid var(--border);
    color:var(--text-muted); padding:3px 8px; border-radius:20px; white-space:nowrap;
  }
  .recipe-desc { font-size:0.82rem; color:var(--text-muted); line-height:1.5; }
  .recipe-meta { font-size:0.75rem; color:var(--border); }
  .recipe-actions { display:flex; gap:7px; margin-top:4px; flex-wrap:wrap; }

  /* recipe detail */
  .ing-chips { display:flex; flex-wrap:wrap; gap:6px; margin-bottom:16px; }
  .ing-chip {
    background:var(--surface2); border:1px solid var(--border); border-radius:20px;
    padding:4px 12px; font-size:0.8rem; color:var(--text-soft);
  }
  .recipe-steps ol { padding-left:18px; color:var(--text-soft); font-size:0.87rem; line-height:1.8; }

  /* recipe picker */
  .recipe-picker-list { max-height:340px; overflow-y:auto; display:flex; flex-direction:column; gap:7px; }
  .recipe-picker-item {
    background:var(--surface2); border:1px solid var(--border); border-radius:8px;
    padding:12px 14px; cursor:pointer; transition:all 0.15s;
  }
  .recipe-picker-item:hover { border-color:var(--accent); }
  .recipe-picker-item .r-name { font-size:0.93rem; color:var(--text); }
  .recipe-picker-item .r-meta { font-size:0.75rem; color:var(--text-muted); margin-top:2px; }

  /* MISC */
  .empty-state { text-align:center; padding:56px 20px; color:var(--text-muted); }
  .empty-state .big { font-size:2.8rem; margin-bottom:10px; }
  .empty-state h3 { font-family:'Playfair Display',serif; font-size:1.2rem; margin-bottom:6px; color:var(--text-soft); }
  .success-banner {
    background:rgba(106,158,111,0.15); border:1px solid var(--success);
    color:var(--success); padding:13px 18px; border-radius:10px; margin-bottom:22px; font-size:0.88rem;
  }

  /* AI FEATURES */
  .ai-badge {
    display:inline-flex; align-items:center; gap:4px;
    background:linear-gradient(135deg,#7c3aed22,#d4a84322);
    border:1px solid #7c3aed55; color:#c084fc;
    font-size:0.65rem; letter-spacing:0.08em; text-transform:uppercase;
    padding:2px 8px; border-radius:20px; font-weight:500;
  }
  .ai-btn {
    background:linear-gradient(135deg,#7c3aed,#a855f7);
    color:#fff; border:none; padding:6px 12px; border-radius:6px;
    font-family:'DM Sans',sans-serif; font-size:0.72rem; font-weight:500;
    cursor:pointer; transition:all 0.2s; white-space:nowrap;
    display:inline-flex; align-items:center; gap:4px;
  }
  .ai-btn:hover { background:linear-gradient(135deg,#6d28d9,#9333ea); transform:translateY(-1px); }
  .ai-btn:disabled { opacity:0.5; cursor:not-allowed; transform:none; }
  .ai-btn-secondary {
    background:none; border:1px solid #7c3aed55; color:#c084fc;
    padding:8px 16px; border-radius:8px; font-family:'DM Sans',sans-serif;
    font-size:0.82rem; cursor:pointer; transition:all 0.2s; display:inline-flex; align-items:center; gap:5px;
  }
  .ai-btn-secondary:hover { background:#7c3aed22; border-color:#a855f7; }
  .ai-btn-secondary:disabled { opacity:0.5; cursor:not-allowed; }

  .ai-key-btn {
    background:none; border:1px solid var(--border); color:var(--text-muted);
    font-family:'DM Sans',sans-serif; font-size:0.75rem; padding:6px 12px;
    border-radius:6px; cursor:pointer; transition:all 0.2s; white-space:nowrap;
  }
  .ai-key-btn:hover { border-color:var(--accent); color:var(--accent); }
  .ai-key-btn.has-key { border-color:#6a9e6f66; color:var(--success); }
  .key-tip { font-size:0.78rem; color:var(--text-muted); line-height:1.5; margin-bottom:14px; }
  .key-tip a { color:var(--accent); text-decoration:none; }
  .key-tip a:hover { text-decoration:underline; }

  /* spinner */
  @keyframes spin { to { transform:rotate(360deg); } }
  .spinner { display:inline-block; width:12px; height:12px; border:2px solid rgba(255,255,255,0.3); border-top-color:#fff; border-radius:50%; animation:spin 0.7s linear infinite; }
  .spinner.dark { border-color:rgba(192,132,252,0.3); border-top-color:#c084fc; }

  /* AI suggestion modal */
  .ai-suggestions { display:flex; flex-direction:column; gap:8px; margin-top:10px; max-height:320px; overflow-y:auto; }
  .ai-suggestion-item {
    background:var(--surface2); border:1px solid var(--border); border-radius:10px;
    padding:13px 15px; cursor:pointer; transition:all 0.15s;
  }
  .ai-suggestion-item:hover { border-color:#a855f7; background:#7c3aed11; }
  .ai-suggestion-item .sug-name { font-size:0.95rem; color:var(--text); margin-bottom:3px; }
  .ai-suggestion-item .sug-why { font-size:0.78rem; color:var(--text-muted); line-height:1.4; }

  /* nutrition chips */
  .nutrition-row { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
  .nutr-chip {
    background:var(--surface2); border:1px solid var(--border); border-radius:8px;
    padding:6px 12px; font-size:0.78rem; text-align:center;
  }
  .nutr-chip .nutr-val { color:var(--accent); font-weight:600; font-size:0.92rem; }
  .nutr-chip .nutr-label { color:var(--text-muted); font-size:0.68rem; text-transform:uppercase; letter-spacing:0.06em; }

  /* pantry match highlight */
  .ingredient-item.in-pantry { border-color:#6a9e6f44; }
  .pantry-flag { font-size:0.68rem; color:var(--success); white-space:nowrap; }

  @media(max-width:768px) {
    header { padding:14px 18px; }
    nav button { padding:6px 10px; font-size:0.72rem; }
    main { padding:22px 14px; }
    .week-grid { grid-template-columns:repeat(2,1fr); }
    .ingredient-row { grid-template-columns:1fr 60px 70px auto; }
  }
</style>
</head>
<body>

<header>
  <div class="logo">& Dine</div>
  <nav>
    <button class="active" onclick="showView('planner')">Week</button>
    <button onclick="showView('recipes')">Recipes <span class="badge" id="rec-badge" style="display:none">0</span></button>
    <button onclick="showView('shopping')">Shopping <span class="badge" id="shop-badge" style="display:none">0</span></button>
    <button onclick="showView('pantry')">Pantry <span class="badge" id="pantry-badge" style="display:none">0</span></button>
  </nav>
</header>

<main>
  <div id="global-error" style="display:none;background:rgba(196,92,58,0.15);border:1px solid var(--danger);color:var(--danger);padding:13px 18px;border-radius:10px;margin-bottom:22px;font-size:0.88rem"></div>

  <!-- PLANNER -->
  <div class="view active" id="view-planner">
    <h1 class="page-title">This Week's Dinners</h1>
    <p class="page-sub">Click a day to pick from your recipe catalog or enter a meal manually.</p>
    <div class="week-grid" id="week-grid"></div>
    <div class="bottom-bar">
      <button class="btn-primary" onclick="generateShoppingList()">Generate Shopping List</button>
      <button class="ai-btn-secondary" onclick="aiPlanWeek()" id="ai-plan-btn">‚ú® AI Plan My Week</button>
      <button class="btn-secondary" onclick="clearWeek()">Clear Week</button>
    </div>
  </div>

  <!-- RECIPES -->
  <div class="view" id="view-recipes">
    <div class="recipes-toolbar">
      <div>
        <h1 class="page-title">Recipe Catalog</h1>
        <p class="page-sub">Your personal dinner library.</p>
      </div>
      <button class="btn-primary" onclick="openRecipeModal(null)">+ New Recipe</button>
    </div>
    <div style="margin-bottom:18px">
      <input type="text" placeholder="Search recipes‚Ä¶" oninput="renderRecipes(this.value)" style="max-width:340px">
    </div>
    <div class="recipes-grid" id="recipes-grid"></div>
  </div>

  <!-- SHOPPING -->
  <div class="view" id="view-shopping">
    <div class="shopping-header">
      <div>
        <h1 class="page-title">Shopping List</h1>
        <p class="page-sub">Tick items off as you go.</p>
      </div>
      <div style="display:flex;gap:9px;flex-wrap:wrap;">
        <button class="btn-secondary" onclick="markAllDone()">Mark all done</button>
        <button class="btn-primary" onclick="shoppingBought()">üõí Done ‚Äî Add to Pantry</button>
      </div>
    </div>
    <div id="shopping-list-container"></div>
  </div>

  <!-- PANTRY -->
  <div class="view" id="view-pantry">
    <div id="success-msg" class="success-banner" style="display:none">‚úì Shopping added to pantry!</div>
    <div class="pantry-toolbar">
      <div>
        <h1 class="page-title">Pantry</h1>
        <p class="page-sub">Items in stock ‚Äî edit quantities or add manually.</p>
      </div>
      <div style="display:flex;gap:9px;flex-wrap:wrap;">
        <button class="btn-secondary" onclick="openAddPantryModal()">+ Add Item</button>
        <button class="btn-secondary" onclick="clearPantry()">Clear All</button>
      </div>
    </div>
    <div id="pantry-container"></div>
  </div>

</main>

<!-- MODAL: Manual Meal -->
<div class="modal-overlay" id="meal-modal">
  <div class="modal">
    <h2 id="modal-day-title">Add Meal</h2>
    <div class="form-group">
      <label>Meal Name</label>
      <input type="text" id="meal-name" placeholder="e.g. Pasta Carbonara">
    </div>
    <div class="form-group">
      <label>Notes (optional)</label>
      <textarea id="meal-notes" placeholder="Recipe steps, tips‚Ä¶"></textarea>
    </div>
    <div class="form-group">
      <label>Ingredients</label>
      <div id="ingredients-container"></div>
      <button class="add-ingredient-btn" onclick="addIngredientRow()">+ Add Ingredient</button>
    </div>
    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeModal('meal-modal')">Cancel</button>
      <button class="btn-primary" onclick="saveMeal()">Save Meal</button>
    </div>
  </div>
</div>

<!-- MODAL: Pick Recipe for Day -->
<div class="modal-overlay" id="picker-modal">
  <div class="modal">
    <h2 id="picker-day-title">Choose a Recipe</h2>
    <div class="form-group" style="margin-bottom:14px">
      <input type="text" id="picker-search" placeholder="Search‚Ä¶" oninput="renderPicker(this.value)">
    </div>
    <div class="recipe-picker-list" id="picker-list"></div>
    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeModal('picker-modal')">Cancel</button>
      <button class="btn-secondary" onclick="openManualFromPicker()">Enter manually instead</button>
    </div>
  </div>
</div>

<!-- MODAL: Add/Edit Recipe -->
<div class="modal-overlay" id="recipe-modal">
  <div class="modal wide">
    <h2 id="recipe-modal-title">New Recipe</h2>
    <div class="form-group">
      <label>Recipe Name</label>
      <div style="display:flex;gap:8px;align-items:center">
        <input type="text" id="rec-name" placeholder="e.g. Chicken Tikka Masala" style="flex:1">
        <button class="ai-btn" onclick="aiGenerateRecipe()" id="ai-gen-btn" title="Fill recipe details with AI">‚ú® AI Fill</button>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div class="form-group">
        <label>Category</label>
        <select id="rec-cat">
          <option>Pasta</option><option>Meat</option><option>Fish</option>
          <option>Vegetarian</option><option>Curry</option><option>Soup</option>
          <option>Salad</option><option>Asian</option><option>Other</option>
        </select>
      </div>
      <div class="form-group">
        <label>Serves</label>
        <input type="text" id="rec-serves" placeholder="e.g. 4">
      </div>
    </div>
    <div class="form-group">
      <label>Description</label>
      <textarea id="rec-desc" placeholder="Brief description‚Ä¶" style="min-height:55px"></textarea>
    </div>
    <div class="form-group">
      <label>Ingredients</label>
      <div id="rec-ingredients-container"></div>
      <button class="add-ingredient-btn" onclick="addRecipeIngRow()">+ Add Ingredient</button>
    </div>
    <div class="form-group">
      <label>Method / Steps</label>
      <textarea id="rec-steps" placeholder="1. Preheat oven to 200¬∞C&#10;2. Fry the onions‚Ä¶" style="min-height:110px"></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeModal('recipe-modal')">Cancel</button>
      <button class="btn-primary" onclick="saveRecipe()">Save Recipe</button>
    </div>
  </div>
</div>

<!-- MODAL: Recipe Detail -->
<div class="modal-overlay" id="recipe-detail-modal">
  <div class="modal wide">
    <div id="recipe-detail-content"></div>
    <div class="modal-actions" id="recipe-detail-actions"></div>
  </div>
</div>

<!-- MODAL: Add/Edit Pantry Item -->
<div class="modal-overlay" id="pantry-modal">
  <div class="modal">
    <h2 id="pantry-modal-title">Add Pantry Item</h2>
    <div class="form-group">
      <label>Item Name</label>
      <input type="text" id="pantry-item-name" placeholder="e.g. Olive Oil">
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div class="form-group">
        <label>Quantity</label>
        <input type="text" id="pantry-item-qty" placeholder="e.g. 500">
      </div>
      <div class="form-group">
        <label>Unit</label>
        <input type="text" id="pantry-item-unit" placeholder="g, ml, pcs‚Ä¶">
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeModal('pantry-modal')">Cancel</button>
      <button class="btn-primary" onclick="savePantryItem()">Save</button>
    </div>
  </div>
</div>

<!-- MODAL: AI Suggest Meal -->
<div class="modal-overlay" id="ai-modal">
  <div class="modal">
    <h2 id="ai-modal-title">‚ú® AI Meal Suggestions</h2>
    <p style="font-size:0.83rem;color:var(--text-muted);margin-bottom:14px" id="ai-modal-sub">Based on your recipe catalog and pantry</p>
    <div id="ai-suggestions-container">
      <div style="text-align:center;padding:30px;color:var(--text-muted)"><div class="spinner dark" style="width:22px;height:22px;margin:0 auto 10px"></div><div style="font-size:0.85rem">Thinking‚Ä¶</div></div>
    </div>
    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeModal('ai-modal')">Cancel</button>
    </div>
  </div>
</div>

<!-- MODAL: AI Plan Week -->
<div class="modal-overlay" id="ai-week-modal">
  <div class="modal">
    <h2>‚ú® AI Week Plan</h2>
    <p style="font-size:0.83rem;color:var(--text-muted);margin-bottom:14px">Tell AI what you're in the mood for this week (optional)</p>
    <div class="form-group">
      <label>Preferences / Notes</label>
      <textarea id="ai-week-prefs" placeholder="e.g. Mostly vegetarian, one fish dish, quick weeknight meals, avoid spicy‚Ä¶" style="min-height:70px"></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeModal('ai-week-modal')">Cancel</button>
      <button class="ai-btn" onclick="runAiWeekPlan()" id="ai-week-go-btn" style="font-size:0.88rem;padding:10px 20px">‚ú® Generate Plan</button>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DEFAULT RECIPES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DEFAULT_RECIPES = [
  {
    id:'r_default_1', name:'Spaghetti Bolognese', category:'Pasta', serves:'4',
    desc:'A rich, slow-cooked Italian meat sauce served over spaghetti.',
    ingredients:[
      {name:'Spaghetti',qty:'400',unit:'g'},{name:'Beef mince',qty:'500',unit:'g'},
      {name:'Onion',qty:'1',unit:''},{name:'Garlic',qty:'3',unit:'cloves'},
      {name:'Carrot',qty:'1',unit:''},{name:'Celery',qty:'2',unit:'sticks'},
      {name:'Chopped tomatoes',qty:'400',unit:'g'},{name:'Tomato pur√©e',qty:'2',unit:'tbsp'},
      {name:'Beef stock',qty:'150',unit:'ml'},{name:'Olive oil',qty:'2',unit:'tbsp'},
      {name:'Parmesan',qty:'50',unit:'g'},
    ],
    steps:'1. Soften onion, carrot and celery in olive oil for 8 mins.\n2. Add garlic, cook 1 min.\n3. Brown the mince, breaking it up.\n4. Stir in tomato pur√©e, chopped tomatoes and stock.\n5. Simmer uncovered for 45 mins until thick.\n6. Cook spaghetti, drain, serve topped with sauce and Parmesan.',
  },
  {
    id:'r_default_2', name:'Chicken Tikka Masala', category:'Curry', serves:'4',
    desc:'Tender marinated chicken in a creamy, spiced tomato sauce.',
    ingredients:[
      {name:'Chicken breast',qty:'700',unit:'g'},{name:'Plain yoghurt',qty:'150',unit:'ml'},
      {name:'Tikka masala paste',qty:'4',unit:'tbsp'},{name:'Onion',qty:'1',unit:''},
      {name:'Garlic',qty:'3',unit:'cloves'},{name:'Fresh ginger',qty:'2',unit:'tsp'},
      {name:'Chopped tomatoes',qty:'400',unit:'g'},{name:'Double cream',qty:'150',unit:'ml'},
      {name:'Basmati rice',qty:'300',unit:'g'},{name:'Coriander',qty:'1',unit:'handful'},
    ],
    steps:'1. Marinate chicken in yoghurt and half the paste for 30 mins.\n2. Grill or griddle chicken until charred, set aside.\n3. Fry onion until golden, add garlic, ginger and remaining paste.\n4. Add tomatoes, simmer 15 mins.\n5. Stir in cream and chicken, cook 5 more mins.\n6. Serve over rice with coriander.',
  },
  {
    id:'r_default_3', name:'Salmon with Roast Veg', category:'Fish', serves:'2',
    desc:'Oven-baked salmon fillets on a tray of colourful roasted vegetables.',
    ingredients:[
      {name:'Salmon fillets',qty:'2',unit:''},{name:'Courgette',qty:'1',unit:''},
      {name:'Red pepper',qty:'1',unit:''},{name:'Cherry tomatoes',qty:'200',unit:'g'},
      {name:'Red onion',qty:'1',unit:''},{name:'Olive oil',qty:'3',unit:'tbsp'},
      {name:'Lemon',qty:'1',unit:''},{name:'Garlic',qty:'2',unit:'cloves'},
    ],
    steps:'1. Preheat oven to 200¬∞C.\n2. Chop all veg, toss with oil and garlic, roast 20 mins.\n3. Nestle salmon on top, squeeze over lemon.\n4. Return to oven for 12‚Äì15 mins until salmon is cooked through.',
  },
  {
    id:'r_default_4', name:'Mushroom Risotto', category:'Vegetarian', serves:'4',
    desc:'A classic creamy Italian risotto with mixed mushrooms.',
    ingredients:[
      {name:'Arborio rice',qty:'320',unit:'g'},{name:'Mixed mushrooms',qty:'400',unit:'g'},
      {name:'Onion',qty:'1',unit:''},{name:'Garlic',qty:'2',unit:'cloves'},
      {name:'White wine',qty:'150',unit:'ml'},{name:'Vegetable stock',qty:'1.2',unit:'l'},
      {name:'Parmesan',qty:'60',unit:'g'},{name:'Butter',qty:'40',unit:'g'},
      {name:'Olive oil',qty:'2',unit:'tbsp'},{name:'Parsley',qty:'1',unit:'handful'},
    ],
    steps:'1. Keep stock warm in a pan.\n2. Fry onion in oil until soft, add garlic.\n3. Add rice, toast 2 mins, pour in wine.\n4. Add stock one ladle at a time, stirring until absorbed (~20 mins).\n5. Meanwhile saut√© mushrooms in butter.\n6. Stir mushrooms, Parmesan and butter into risotto. Season and serve.',
  },
  {
    id:'r_default_5', name:'Beef Tacos', category:'Meat', serves:'4',
    desc:'Juicy spiced beef mince in warm tortillas with all the toppings.',
    ingredients:[
      {name:'Beef mince',qty:'500',unit:'g'},{name:'Taco seasoning',qty:'2',unit:'tbsp'},
      {name:'Small tortillas',qty:'8',unit:''},{name:'Cheddar cheese',qty:'100',unit:'g'},
      {name:'Sour cream',qty:'100',unit:'ml'},{name:'Salsa',qty:'150',unit:'g'},
      {name:'Avocado',qty:'2',unit:''},{name:'Lime',qty:'1',unit:''},
      {name:'Iceberg lettuce',qty:'0.5',unit:'head'},
    ],
    steps:'1. Brown mince in a pan, drain excess fat.\n2. Add taco seasoning and a splash of water, cook 3 mins.\n3. Warm tortillas in a dry pan or microwave.\n4. Slice avocado, squeeze over lime.\n5. Assemble tacos with mince, cheese, lettuce, salsa, sour cream and avocado.',
  },
  {
    id:'r_default_6', name:'Thai Green Curry', category:'Asian', serves:'4',
    desc:'Fragrant, creamy coconut curry with chicken and vegetables.',
    ingredients:[
      {name:'Chicken breast',qty:'600',unit:'g'},{name:'Green curry paste',qty:'3',unit:'tbsp'},
      {name:'Coconut milk',qty:'400',unit:'ml'},{name:'Fish sauce',qty:'2',unit:'tbsp'},
      {name:'Courgette',qty:'1',unit:''},{name:'Sugar snap peas',qty:'150',unit:'g'},
      {name:'Lime leaves',qty:'4',unit:''},{name:'Lemongrass',qty:'1',unit:'stalk'},
      {name:'Thai basil',qty:'1',unit:'handful'},{name:'Jasmine rice',qty:'300',unit:'g'},
    ],
    steps:'1. Fry curry paste in a little oil for 1 min.\n2. Add coconut milk, lemongrass and lime leaves, bring to simmer.\n3. Add chicken, cook 10 mins.\n4. Add veg, cook 5 more mins.\n5. Season with fish sauce. Stir in basil.\n6. Serve with jasmine rice.',
  },
  {
    id:'r_default_7', name:'Roasted Tomato Soup', category:'Soup', serves:'4',
    desc:'A simple, velvety roasted tomato soup ‚Äî perfect with crusty bread.',
    ingredients:[
      {name:'Ripe tomatoes',qty:'1',unit:'kg'},{name:'Onion',qty:'1',unit:''},
      {name:'Garlic',qty:'4',unit:'cloves'},{name:'Vegetable stock',qty:'500',unit:'ml'},
      {name:'Olive oil',qty:'3',unit:'tbsp'},{name:'Double cream',qty:'50',unit:'ml'},
      {name:'Basil',qty:'1',unit:'handful'},{name:'Crusty bread',qty:'1',unit:'loaf'},
    ],
    steps:'1. Halve tomatoes and place cut-side up on a tray with onion, garlic and oil. Roast at 190¬∞C for 40 mins.\n2. Transfer to a blender with stock, blend until smooth.\n3. Pass through a sieve for extra smoothness if desired.\n4. Reheat gently, stir in cream, season.\n5. Serve with fresh basil and crusty bread.',
  },
  {
    id:'r_default_8', name:'Prawn Stir Fry', category:'Asian', serves:'2',
    desc:'Quick and punchy king prawn stir fry with noodles in a sticky sauce.',
    ingredients:[
      {name:'King prawns',qty:'300',unit:'g'},{name:'Egg noodles',qty:'200',unit:'g'},
      {name:'Red pepper',qty:'1',unit:''},{name:'Pak choi',qty:'2',unit:'heads'},
      {name:'Spring onions',qty:'3',unit:''},{name:'Garlic',qty:'2',unit:'cloves'},
      {name:'Soy sauce',qty:'3',unit:'tbsp'},{name:'Oyster sauce',qty:'2',unit:'tbsp'},
      {name:'Sesame oil',qty:'1',unit:'tsp'},{name:'Fresh ginger',qty:'1',unit:'tsp'},
    ],
    steps:'1. Cook noodles, drain and toss in sesame oil.\n2. Heat wok until smoking, add oil, garlic and ginger.\n3. Add prawns, stir fry 2 mins.\n4. Add veg, stir fry 2 more mins.\n5. Add noodles and sauces, toss everything together for 1 min.\n6. Serve immediately with sliced spring onions.',
  },
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DAYS = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
const API = 'https://d1-template.exposurephotographer0.workers.dev';

let state = { meals:{}, recipes:[], shoppingList:[], pantry:[] };
let editingDay = null, pickerDay = null;
let ingredientCount = 0, recIngCount = 0;
let editingRecipeId = null, editingPantryIdx = null;

async function apiFetch(path, opts = {}) {
  const resp = await fetch(API + path, {
    headers: { 'Content-Type': 'application/json' },
    ...opts,
  });
  if (!resp.ok) throw new Error(`API error ${resp.status} on ${path}`);
  return resp.json();
}

async function loadState() {
  showLoadingOverlay(true);
  try {
    const [recipes, meals, pantry, shopping] = await Promise.all([
      apiFetch('/api/recipes'),
      apiFetch('/api/meals'),
      apiFetch('/api/pantry'),
      apiFetch('/api/shopping'),
    ]);
    // Seed default recipes if DB is empty
    if (recipes.length === 0) {
      await Promise.all(DEFAULT_RECIPES.map(r =>
        apiFetch('/api/recipes', { method:'POST', body: JSON.stringify(r) })
      ));
      state.recipes = DEFAULT_RECIPES.map(r => ({...r}));
    } else {
      state.recipes = recipes;
    }
    state.meals = meals;
    state.pantry = pantry;
    state.shoppingList = shopping;
  } catch(e) {
    showError('Could not connect to your Cloudflare Worker. Make sure it is deployed and the URL is correct.');
    console.error(e);
  } finally {
    showLoadingOverlay(false);
  }
}

function showLoadingOverlay(show) {
  document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
}
function showError(msg) {
  const el = document.getElementById('global-error');
  el.textContent = msg;
  el.style.display = msg ? 'block' : 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
loadState().then(() => {
  renderWeek(); renderRecipes(); renderShopping(); renderPantry(); updateBadges();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NAV ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showView(name) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById('view-' + name).classList.add('active');
  const names = ['planner','recipes','shopping','pantry'];
  document.querySelectorAll('nav button').forEach((b,i) => b.classList.toggle('active', names[i]===name));
}
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.modal-overlay').forEach(el => {
  el.addEventListener('click', function(e) { if(e.target===this) this.classList.remove('open'); });
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê WEEK PLANNER (see AI section above for renderWeek) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ Recipe Picker ‚îÄ
function openPickerModal(dayIndex) {
  pickerDay = dayIndex;
  document.getElementById('picker-day-title').textContent = DAYS[dayIndex];
  document.getElementById('picker-search').value = '';
  renderPicker('');
  document.getElementById('picker-modal').classList.add('open');
}
function renderPicker(search) {
  const list = document.getElementById('picker-list');
  const q = (search||'').toLowerCase();
  const filtered = state.recipes.filter(r => r.name.toLowerCase().includes(q) || r.category.toLowerCase().includes(q));
  if (!filtered.length) { list.innerHTML='<div style="color:var(--text-muted);font-size:0.85rem;padding:12px">No recipes match.</div>'; return; }
  list.innerHTML = filtered.map(r => `
    <div class="recipe-picker-item" onclick="pickRecipe('${r.id}')">
      <div class="r-name">${r.name}</div>
      <div class="r-meta">${r.category} ¬∑ Serves ${r.serves} ¬∑ ${r.ingredients.length} ingredients</div>
    </div>`).join('');
}
function pickRecipe(recipeId) {
  const recipe = state.recipes.find(r => r.id===recipeId);
  if (!recipe) return;
  const meal = { name:recipe.name, notes:recipe.steps||'', ingredients:recipe.ingredients.map(i=>({...i})), recipeId:recipe.id };
  state.meals[pickerDay] = meal;
  apiFetch('/api/meals', { method:'POST', body: JSON.stringify({ dayIndex: pickerDay, meal }) });
  closeModal('picker-modal'); renderWeek();
}
function openManualFromPicker() { closeModal('picker-modal'); openMealModal(pickerDay); }

// ‚îÄ Manual Meal ‚îÄ
function openMealModal(dayIndex) {
  editingDay = dayIndex;
  const meal = state.meals[dayIndex];
  document.getElementById('modal-day-title').textContent = DAYS[dayIndex];
  document.getElementById('meal-name').value = meal ? meal.name : '';
  document.getElementById('meal-notes').value = meal ? (meal.notes||'') : '';
  const container = document.getElementById('ingredients-container');
  container.innerHTML = ''; ingredientCount = 0;
  if (meal && meal.ingredients.length > 0) meal.ingredients.forEach(ing => addIngredientRow(ing));
  else addIngredientRow();
  document.getElementById('meal-modal').classList.add('open');
  setTimeout(() => document.getElementById('meal-name').focus(), 50);
}
function addIngredientRow(ing=null) {
  const id = ingredientCount++;
  const container = document.getElementById('ingredients-container');
  const row = document.createElement('div');
  row.className='ingredient-row'; row.id=`ing-row-${id}`;
  row.innerHTML = `
    <input type="text" placeholder="Ingredient" value="${ing?esc(ing.name):''}" id="ing-name-${id}">
    <input type="text" placeholder="Qty" value="${ing?esc(ing.qty):''}" id="ing-qty-${id}">
    <input type="text" placeholder="Unit" value="${ing?esc(ing.unit):''}" id="ing-unit-${id}">
    <button class="icon-btn" onclick="document.getElementById('ing-row-${id}').remove()">√ó</button>`;
  container.appendChild(row);
}
function saveMeal() {
  const name = document.getElementById('meal-name').value.trim();
  if (!name) { alert('Please enter a meal name.'); return; }
  const meal = { name, notes: document.getElementById('meal-notes').value.trim(), ingredients: collectIngredients('ing') };
  state.meals[editingDay] = meal;
  apiFetch('/api/meals', { method:'POST', body: JSON.stringify({ dayIndex: editingDay, meal }) });
  closeModal('meal-modal'); renderWeek();
}
function removeMeal(dayIndex) {
  delete state.meals[dayIndex];
  apiFetch('/api/meals', { method:'POST', body: JSON.stringify({ dayIndex, meal: null }) });
  renderWeek();
}
function clearWeek() {
  if (!confirm('Clear all meals this week?')) return;
  state.meals = {};
  apiFetch('/api/meals/clear', { method:'POST' });
  renderWeek();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RECIPES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderRecipes(search) {
  const grid = document.getElementById('recipes-grid');
  const q = (search||'').toLowerCase();
  const filtered = state.recipes.filter(r =>
    r.name.toLowerCase().includes(q) || r.category.toLowerCase().includes(q) || (r.desc||'').toLowerCase().includes(q));
  if (!filtered.length) {
    grid.innerHTML=`<div class="empty-state"><div class="big">üìñ</div><h3>No recipes found</h3><p>Add your first recipe above.</p></div>`;
    return;
  }
  grid.innerHTML = filtered.map(r => `
    <div class="recipe-card">
      <div class="recipe-card-header">
        <div class="recipe-name">${r.name}</div>
        <span class="recipe-tag">${r.category}</span>
      </div>
      <div class="recipe-desc">${r.desc||''}</div>
      <div class="recipe-meta">Serves ${r.serves} ¬∑ ${r.ingredients.length} ingredients</div>
      <div class="recipe-actions">
        <button class="btn-sm" onclick="viewRecipe('${r.id}')">View</button>
        <button class="btn-sm" onclick="openRecipeModal('${r.id}')">Edit</button>
        <button class="btn-sm danger" onclick="deleteRecipe('${r.id}')">Delete</button>
      </div>
    </div>`).join('');
  updateBadges();
}

function viewRecipe(id) {
  const r = state.recipes.find(x => x.id===id);
  if (!r) return;
  const steps = (r.steps||'').split('\n').filter(s=>s.trim());
  document.getElementById('recipe-detail-content').innerHTML = `
    <h2>${r.name}</h2>
    <div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap">
      <span class="recipe-tag">${r.category}</span>
      <span class="recipe-tag">Serves ${r.serves}</span>
    </div>
    ${r.desc?`<p style="color:var(--text-muted);font-size:0.87rem;margin-bottom:18px;line-height:1.6">${r.desc}</p>`:''}
    <div style="font-size:0.73rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-muted);margin-bottom:8px">Ingredients</div>
    <div class="ing-chips" style="margin-bottom:22px">
      ${r.ingredients.map(i=>`<span class="ing-chip">${i.name}${i.qty?' ‚Äî '+i.qty+' '+(i.unit||''):''}</span>`).join('')}
    </div>
    ${steps.length?`
      <div style="font-size:0.73rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-muted);margin-bottom:8px">Method</div>
      <div class="recipe-steps"><ol>${steps.map(s=>`<li>${s.replace(/^\d+\.\s*/,'')}</li>`).join('')}</ol></div>
    `:''}`;
  document.getElementById('recipe-detail-actions').innerHTML = `
    <button class="btn-secondary" onclick="closeModal('recipe-detail-modal')">Close</button>
    <button class="btn-secondary" onclick="closeModal('recipe-detail-modal');openRecipeModal('${r.id}')">Edit</button>`;
  document.getElementById('recipe-detail-modal').classList.add('open');
}

function openRecipeModal(id) {
  editingRecipeId = id;
  const r = id ? state.recipes.find(x => x.id===id) : null;
  document.getElementById('recipe-modal-title').textContent = r ? 'Edit Recipe' : 'New Recipe';
  document.getElementById('rec-name').value = r ? r.name : '';
  document.getElementById('rec-cat').value = r ? r.category : 'Pasta';
  document.getElementById('rec-serves').value = r ? r.serves : '4';
  document.getElementById('rec-desc').value = r ? (r.desc||'') : '';
  document.getElementById('rec-steps').value = r ? (r.steps||'') : '';
  const container = document.getElementById('rec-ingredients-container');
  container.innerHTML=''; recIngCount=0;
  if (r && r.ingredients.length>0) r.ingredients.forEach(ing => addRecipeIngRow(ing));
  else addRecipeIngRow();
  document.getElementById('recipe-modal').classList.add('open');
  setTimeout(() => document.getElementById('rec-name').focus(), 50);
}
function addRecipeIngRow(ing=null) {
  const id = recIngCount++;
  const container = document.getElementById('rec-ingredients-container');
  const row = document.createElement('div');
  row.className='ingredient-row'; row.id=`ring-row-${id}`;
  row.innerHTML = `
    <input type="text" placeholder="Ingredient" value="${ing?esc(ing.name):''}" id="ring-name-${id}">
    <input type="text" placeholder="Qty" value="${ing?esc(ing.qty):''}" id="ring-qty-${id}">
    <input type="text" placeholder="Unit" value="${ing?esc(ing.unit):''}" id="ring-unit-${id}">
    <button class="icon-btn" onclick="document.getElementById('ring-row-${id}').remove()">√ó</button>`;
  container.appendChild(row);
}
function saveRecipe() {
  const name = document.getElementById('rec-name').value.trim();
  if (!name) { alert('Please enter a recipe name.'); return; }
  const recipe = {
    id: editingRecipeId || 'r_'+Date.now(),
    name, category:document.getElementById('rec-cat').value,
    serves:document.getElementById('rec-serves').value.trim(),
    desc:document.getElementById('rec-desc').value.trim(),
    steps:document.getElementById('rec-steps').value.trim(),
    ingredients:collectIngredients('ring'),
  };
  if (editingRecipeId) {
    const idx = state.recipes.findIndex(r=>r.id===editingRecipeId);
    if (idx>-1) state.recipes[idx]=recipe; else state.recipes.push(recipe);
  } else { state.recipes.push(recipe); }
  apiFetch('/api/recipes', { method:'POST', body: JSON.stringify(recipe) });
  closeModal('recipe-modal');
  const searchEl = document.querySelector('#view-recipes input');
  renderRecipes(searchEl ? searchEl.value : '');
  updateBadges();
}
function deleteRecipe(id) {
  if (!confirm('Delete this recipe?')) return;
  state.recipes = state.recipes.filter(r=>r.id!==id);
  apiFetch('/api/recipes/'+id, { method:'DELETE' });
  const searchEl = document.querySelector('#view-recipes input');
  renderRecipes(searchEl ? searchEl.value : '');
  updateBadges();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SHOPPING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function generateShoppingList() {
  const all = [];
  DAYS.forEach((_,i) => {
    const meal = state.meals[i];
    if (meal) meal.ingredients.forEach(ing => all.push({...ing, meal:meal.name, checked:false}));
  });
  if (!all.length) { alert('No ingredients found. Add some meals with ingredients first.'); return; }
  const merged = {};
  all.forEach(ing => {
    const key = ing.name.toLowerCase();
    if (merged[key]) {
      merged[key].meals.push(ing.meal);
      const q1=parseFloat(merged[key].qty), q2=parseFloat(ing.qty);
      if (!isNaN(q1)&&!isNaN(q2)&&merged[key].unit===ing.unit) merged[key].qty=(q1+q2).toString();
    } else { merged[key]={...ing, meals:[ing.meal]}; }
  });
  state.shoppingList = Object.values(merged).map(ing => ({name:ing.name,qty:ing.qty,unit:ing.unit,meals:ing.meals,checked:false}));
  apiFetch('/api/shopping', { method:'POST', body: JSON.stringify(state.shoppingList) });
  renderShopping(); updateBadges(); showView('shopping');
}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SHOPPING (renderShopping is in AI section) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleShopItem(idx, checked) {
  const item = state.shoppingList[idx];
  if (!item) return;
  item.checked = checked;
  apiFetch(`/api/shopping/${item.id}/check`, { method:'POST', body: JSON.stringify({ checked }) });
  updateBadges();
  const el = document.getElementById(`shop-item-${idx}`);
  if (el) { el.classList.toggle('checked', checked); }
}
function markAllDone() {
  state.shoppingList.forEach(i => i.checked = true);
  apiFetch('/api/shopping', { method:'POST', body: JSON.stringify(state.shoppingList) });
  renderShopping(); updateBadges();
}
async function shoppingBought() {
  if (!state.shoppingList||!state.shoppingList.length) return;
  const toBuy = state.shoppingList.filter(i=>i.checked);
  if (!toBuy.length) { alert('Tick some items first.'); return; }
  await apiFetch('/api/shopping/bought', { method:'POST' });
  // Reload fresh state from DB
  state.shoppingList = await apiFetch('/api/shopping');
  state.pantry = await apiFetch('/api/pantry');
  renderShopping(); renderPantry(); updateBadges(); showView('pantry');
  const msg=document.getElementById('success-msg');
  msg.style.display='block'; setTimeout(()=>msg.style.display='none',4000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PANTRY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderPantry() {
  const container=document.getElementById('pantry-container');
  if (!state.pantry||!state.pantry.length) {
    container.innerHTML=`<div class="empty-state"><div class="big">ü•´</div><h3>Pantry is empty</h3><p>Complete your shopping or add items manually.</p></div>`;
    return;
  }
  let html='<div class="pantry-grid">';
  state.pantry.forEach((item,i) => {
    html+=`<div class="pantry-item">
      <div class="pantry-item-info">
        <div class="p-name">${item.name}</div>
        <div class="p-qty">${item.qty?item.qty+' '+(item.unit||''):(item.unit||'‚Äî')}</div>
        <div class="p-added">Added ${item.added_date||item.addedDate||''}</div>
      </div>
      <div class="pantry-item-actions">
        <button class="edit-btn" onclick="openEditPantryModal(${i})">Edit</button>
        <button class="remove-btn" onclick="removePantryItem(${i})">√ó</button>
      </div>
    </div>`;
  });
  html+='</div>';
  container.innerHTML=html;
}
function openAddPantryModal() {
  editingPantryIdx=null;
  document.getElementById('pantry-modal-title').textContent='Add Pantry Item';
  document.getElementById('pantry-item-name').value='';
  document.getElementById('pantry-item-qty').value='';
  document.getElementById('pantry-item-unit').value='';
  document.getElementById('pantry-modal').classList.add('open');
  setTimeout(()=>document.getElementById('pantry-item-name').focus(),50);
}
function openEditPantryModal(idx) {
  editingPantryIdx=idx;
  const item=state.pantry[idx];
  document.getElementById('pantry-modal-title').textContent='Edit Pantry Item';
  document.getElementById('pantry-item-name').value=item.name;
  document.getElementById('pantry-item-qty').value=item.qty||'';
  document.getElementById('pantry-item-unit').value=item.unit||'';
  document.getElementById('pantry-modal').classList.add('open');
  setTimeout(()=>document.getElementById('pantry-item-qty').focus(),50);
}
async function savePantryItem() {
  const name=document.getElementById('pantry-item-name').value.trim();
  if (!name) { alert('Please enter an item name.'); return; }
  const qty=document.getElementById('pantry-item-qty').value.trim();
  const unit=document.getElementById('pantry-item-unit').value.trim();
  const date=new Date().toLocaleDateString('en-GB',{day:'numeric',month:'short'});
  if (editingPantryIdx!==null) {
    const item = state.pantry[editingPantryIdx];
    state.pantry[editingPantryIdx]={...item,name,qty,unit};
    await apiFetch(`/api/pantry/${item.id}`, { method:'PUT', body: JSON.stringify({name,qty,unit}) });
  } else {
    await apiFetch('/api/pantry', { method:'POST', body: JSON.stringify({name,qty,unit,addedDate:date}) });
    state.pantry = await apiFetch('/api/pantry');
  }
  closeModal('pantry-modal'); renderPantry(); updateBadges();
}
async function removePantryItem(i) {
  const item = state.pantry[i];
  state.pantry.splice(i,1);
  await apiFetch(`/api/pantry/${item.id}`, { method:'DELETE' });
  renderPantry(); updateBadges();
}
function clearPantry() {
  if (!confirm('Clear the entire pantry?')) return;
  state.pantry=[];
  apiFetch('/api/pantry/clear', { method:'POST' });
  renderPantry(); updateBadges();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AI FEATURES (proxied via Worker ‚Äî no credentials in browser) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function updateKeyStatus() {} // no-op, kept for safety
function openKeyModal() {}
function requireKey() { return true; }

async function callClaude(systemPrompt, userMsg) {
  const resp = await fetch(API + '/api/ai', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ system: systemPrompt, user: userMsg }),
  });
  if (!resp.ok) {
    const e = await resp.json().catch(() => ({}));
    throw new Error(e.error || `AI error ${resp.status}`);
  }
  const data = await resp.json();
  return data.response || '';
}

function safeParseJSON(text) {
  const clean = text.replace(/```json|```/g, '').trim();
  return JSON.parse(clean);
}

// Suggest meals for a single day
async function aiSuggestDay(dayIndex) {
  if (!requireKey()) return;
  const modal = document.getElementById('ai-modal');
  document.getElementById('ai-modal-title').textContent = `‚ú® Suggestions for ${DAYS[dayIndex]}`;
  document.getElementById('ai-modal-sub').textContent = 'Tailored to your catalog and what you have this week';
  document.getElementById('ai-suggestions-container').innerHTML =
    `<div style="text-align:center;padding:30px;color:var(--text-muted)"><div class="spinner dark" style="width:22px;height:22px;margin:0 auto 10px"></div><div style="font-size:0.85rem">Thinking‚Ä¶</div></div>`;
  modal.classList.add('open');
  modal._dayIndex = dayIndex;

  const planned = DAYS.map((d,i) => state.meals[i] ? `${d}: ${state.meals[i].name}` : null).filter(Boolean);
  const pantryNames = state.pantry.map(p => p.name);
  const recipeNames = state.recipes.map(r => r.name);

  try {
    const raw = await callClaude(
      'You are a dinner planning assistant. Respond ONLY with valid JSON ‚Äî no markdown, no explanation.',
      `I need 4 dinner suggestions for ${DAYS[dayIndex]}.
Already planned this week: ${planned.join(', ') || 'nothing yet'}.
My recipe catalog: ${recipeNames.slice(0,20).join(', ')}.
Pantry items I have: ${pantryNames.slice(0,20).join(', ') || 'unknown'}.

Return JSON array of exactly 4 objects: [{"name":"...","why":"...","fromCatalog":true/false}]
"why" should be a short reason (max 15 words) why this suits today. "fromCatalog" true if it matches a recipe from my catalog.`
    );
    const suggestions = safeParseJSON(raw);
    const html = suggestions.map(s => `
      <div class="ai-suggestion-item" onclick="pickAiSuggestion(${dayIndex},'${s.name.replace(/'/g,"\\'")}')">
        <div class="sug-name">${s.name} ${s.fromCatalog ? '<span class="ai-badge">üìñ In catalog</span>' : ''}</div>
        <div class="sug-why">${s.why}</div>
      </div>`).join('');
    document.getElementById('ai-suggestions-container').innerHTML =
      `<div class="ai-suggestions">${html}</div>`;
  } catch(e) {
    document.getElementById('ai-suggestions-container').innerHTML =
      `<div style="color:var(--danger);font-size:0.85rem;padding:16px">${e.message || 'Could not get suggestions.'}<br><br><button class="btn-sm" onclick="closeModal('ai-modal');openKeyModal()">‚òÅÔ∏è Check CF credentials</button></div>`;
  }
}

function pickAiSuggestion(dayIndex, name) {
  const recipe = state.recipes.find(r => r.name.toLowerCase() === name.toLowerCase());
  const meal = recipe
    ? { name: recipe.name, notes: recipe.steps||'', ingredients: recipe.ingredients.map(i=>({...i})), recipeId: recipe.id }
    : { name, notes: '', ingredients: [] };
  state.meals[dayIndex] = meal;
  apiFetch('/api/meals', { method:'POST', body: JSON.stringify({ dayIndex, meal }) });
  closeModal('ai-modal'); renderWeek();
}

// Plan the entire week with AI
function aiPlanWeek() {
  if (!requireKey()) return;
  document.getElementById('ai-week-prefs').value = '';
  document.getElementById('ai-week-modal').classList.add('open');
}
async function runAiWeekPlan() {
  const btn = document.getElementById('ai-week-go-btn');
  const prefs = document.getElementById('ai-week-prefs').value.trim();
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Planning‚Ä¶';

  const recipeNames = state.recipes.map(r => r.name);
  const pantryNames = state.pantry.map(p => p.name);

  try {
    const raw = await callClaude(
      'You are a dinner planning assistant. Respond ONLY with valid JSON ‚Äî no markdown, no explanation.',
      `Plan 7 dinners for Monday through Sunday.
My recipe catalog: ${recipeNames.join(', ') || 'none'}.
Pantry: ${pantryNames.join(', ') || 'unknown'}.
Preferences: ${prefs || 'none'}.

Return JSON array of 7 objects (one per day, Monday first):
[{"day":"Monday","name":"...","fromCatalog":true/false}]
Prioritise using recipes from the catalog. Vary the types of food. Keep variety across the week.`
    );
    const plan = safeParseJSON(raw);
    closeModal('ai-week-modal');
    const saves = [];
    plan.forEach((item, i) => {
      if (i > 6) return;
      const recipe = state.recipes.find(r => r.name.toLowerCase() === item.name.toLowerCase());
      const meal = recipe
        ? { name: recipe.name, notes: recipe.steps||'', ingredients: recipe.ingredients.map(x=>({...x})), recipeId: recipe.id }
        : { name: item.name, notes: '', ingredients: [] };
      state.meals[i] = meal;
      saves.push(apiFetch('/api/meals', { method:'POST', body: JSON.stringify({ dayIndex: i, meal }) }));
    });
    await Promise.all(saves);
    renderWeek();
  } catch(e) {
    alert(e.message || 'Could not generate plan. Check your Cloudflare credentials.');
  } finally {
    btn.disabled = false;
    btn.innerHTML = '‚ú® Generate Plan';
  }
}

// AI fill recipe details
async function aiGenerateRecipe() {
  if (!requireKey()) return;
  const name = document.getElementById('rec-name').value.trim();
  if (!name) { alert('Enter a recipe name first.'); return; }
  const btn = document.getElementById('ai-gen-btn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span>';

  try {
    const raw = await callClaude(
      'You are a recipe assistant. Respond ONLY with valid JSON ‚Äî no markdown, no explanation.',
      `Generate a complete recipe for: "${name}"
Return JSON with these exact keys:
{
  "category": "(Pasta|Meat|Fish|Vegetarian|Curry|Soup|Salad|Asian|Other)",
  "serves": "4",
  "desc": "One sentence description",
  "ingredients": [{"name":"...","qty":"...","unit":"..."}],
  "steps": "1. Step one\\n2. Step two\\n..."
}
Include 6-12 ingredients with quantities. 4-8 steps.`
    );
    const r = safeParseJSON(raw);

    // Fill category
    const catEl = document.getElementById('rec-cat');
    if (r.category) {
      for (let o of catEl.options) { if (o.value === r.category) { catEl.value = r.category; break; } }
    }
    if (r.serves) document.getElementById('rec-serves').value = r.serves;
    if (r.desc) document.getElementById('rec-desc').value = r.desc;
    if (r.steps) document.getElementById('rec-steps').value = r.steps;

    // Fill ingredients
    const container = document.getElementById('rec-ingredients-container');
    container.innerHTML = ''; recIngCount = 0;
    (r.ingredients || []).forEach(ing => addRecipeIngRow(ing));
  } catch(e) {
    alert(e.message || 'Could not generate recipe. Check your Cloudflare credentials.');
  } finally {
    btn.disabled = false;
    btn.innerHTML = '‚ú® AI Fill';
  }
}

// Pantry-aware shopping list
function renderShopping() {
  const container = document.getElementById('shopping-list-container');
  if (!state.shoppingList||!state.shoppingList.length) {
    container.innerHTML=`<div class="empty-state"><div class="big">üõí</div><h3>No shopping list yet</h3><p>Plan your dinners then hit "Generate Shopping List".</p></div>`;
    return;
  }
  const pantryMap = {};
  (state.pantry||[]).forEach(p => { pantryMap[p.name.toLowerCase()] = p; });

  let html='<div class="ingredient-list">';
  state.shoppingList.forEach((item,i) => {
    const inPantry = pantryMap[item.name.toLowerCase()];
    html+=`<div class="ingredient-item ${item.checked?'checked':''} ${inPantry?'in-pantry':''}" id="shop-item-${i}">
      <input type="checkbox" ${item.checked?'checked':''} onchange="toggleShopItem(${i},this.checked)">
      <span class="ing-name">${item.name}</span>
      <span class="ing-qty">${item.qty?item.qty+' '+(item.unit||''):(item.unit||'')}</span>
      ${inPantry ? `<span class="pantry-flag">‚úì In pantry</span>` : ''}
      <span class="ing-meal">${item.meals?item.meals.join(', '):''}</span>
    </div>`;
  });
  html+='</div>';
  const inPantryCount = state.shoppingList.filter(i => pantryMap[i.name.toLowerCase()]).length;
  if (inPantryCount > 0) {
    html = `<div style="background:#6a9e6f15;border:1px solid #6a9e6f44;border-radius:10px;padding:11px 15px;margin-bottom:14px;font-size:0.83rem;color:var(--success)">
      ‚úì ${inPantryCount} item${inPantryCount!==1?'s':''} already in your pantry ‚Äî you may already have ${inPantryCount===1?'it':'them'}!
    </div>` + html;
  }
  container.innerHTML=html;
}

// Show AI suggest button on each day card
function renderWeek() {
  const grid = document.getElementById('week-grid');
  grid.innerHTML = '';
  DAYS.forEach((day,i) => {
    const meal = state.meals[i];
    const card = document.createElement('div');
    card.className = 'day-card';
    card.innerHTML = `
      <div class="day-label">${day}</div>
      <div class="day-meal ${meal?'':'empty'}">${meal ? meal.name : 'No meal planned'}</div>
      ${meal ? `<div style="font-size:0.73rem;color:var(--text-muted)">${meal.ingredients.length} ingredient${meal.ingredients.length!==1?'s':''}</div>` : ''}
      <div class="day-actions">
        ${!meal
          ? `<button class="btn-sm" onclick="openPickerModal(${i})">+ Add</button>
             <button class="ai-btn" onclick="aiSuggestDay(${i})" title="Get AI suggestions" style="font-size:0.65rem;padding:4px 8px">‚ú®</button>`
          : `<button class="btn-sm" onclick="openPickerModal(${i})">Change</button>
             <button class="btn-sm" onclick="openMealModal(${i})">Edit</button>
             <button class="btn-sm danger" onclick="removeMeal(${i})">Remove</button>`
        }
      </div>`;
    grid.appendChild(card);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HELPERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function collectIngredients(prefix) {
  const ings=[];
  document.querySelectorAll(`[id^="${prefix}-row-"]`).forEach(row => {
    const id=row.id.replace(`${prefix}-row-`,'');
    const n=document.getElementById(`${prefix}-name-${id}`);
    if (n&&n.value.trim()) ings.push({
      name:n.value.trim(),
      qty:(document.getElementById(`${prefix}-qty-${id}`)?.value||'').trim(),
      unit:(document.getElementById(`${prefix}-unit-${id}`)?.value||'').trim(),
    });
  });
  return ings;
}
function esc(s) { return (s||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function updateBadges() {
  const shopCount=(state.shoppingList||[]).filter(i=>!i.checked).length;
  const pantryCount=(state.pantry||[]).length;
  const recCount=(state.recipes||[]).length;
  const sb=document.getElementById('shop-badge'); sb.textContent=shopCount; sb.style.display=shopCount>0?'inline':'none';
  const pb=document.getElementById('pantry-badge'); pb.textContent=pantryCount; pb.style.display=pantryCount>0?'inline':'none';
  const rb=document.getElementById('rec-badge'); rb.textContent=recCount; rb.style.display=recCount>0?'inline':'none';
}
</script>
<div id="loading-overlay" style="display:none;position:fixed;inset:0;background:rgba(15,14,12,0.85);z-index:500;align-items:center;justify-content:center;flex-direction:column;gap:14px">
  <div class="spinner dark" style="width:32px;height:32px"></div>
  <div style="color:var(--text-muted);font-size:0.9rem">Loading your data‚Ä¶</div>
</div>

</body>
</html>
